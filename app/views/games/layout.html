<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8" />
	<!-- Set the viewport width to device width for mobile -->
	<meta name="viewport" content="width=device-width" />
	<title>{{ title }}</title>
	<!-- Included CSS Files -->
	<link rel="stylesheet" href="/css/app.css">
	<script src="/lib/custom.modernizr.js"></script>
	<script src="/lib/jquery/jquery.min.js"></script>
	<script src="/lib/angular/angular.min.js"></script>
	<script src="/lib/angular-resource/angular-resource.min.js"></script>
	<script src="/lib/angular-cookies/angular-cookies.min.js"></script>
	<script src="/js/init.js"></script>
	<script src="/js/app.js"></script>
	<script src="/js/config.js"></script>
	<script src="/js/directives.js"></script>
	<script src="/js/services/games.js"></script>
	<script src="/js/controllers/games.js"></script>
</head>
<body>
  {% block content %}
  {% endblock %}
	<script src="/lib/foundation/foundation.js"></script>
	<script src="/lib/foundation/foundation.alerts.js"></script>
	<script src="/lib/foundation/foundation.clearing.js"></script>
	<script src="/lib/foundation/foundation.cookie.js"></script>
	<script src="/lib/foundation/foundation.dropdown.js"></script>
	<script src="/lib/foundation/foundation.forms.js"></script>
	<script src="/lib/foundation/foundation.interchange.js"></script>
	<script src="/lib/foundation/foundation.joyride.js"></script>
	<script src="/lib/foundation/foundation.magellan.js"></script>
	<script src="/lib/foundation/foundation.orbit.js"></script>
	<script src="/lib/foundation/foundation.placeholder.js"></script>
	<script src="/lib/foundation/foundation.reveal.js"></script>
	<script src="/lib/foundation/foundation.section.js"></script>
	<script src="/lib/foundation/foundation.tooltips.js"></script>
	<script src="/lib/foundation/foundation.topbar.js"></script>
	<script src="http://js.arcgis.com/3.6/"></script>
    <script>
      var map;
      require(["esri/map", 
			   "dojo/on",
			   "esri/toolbars/edit",
			   "dojo/_base/Color",
			   "esri/dijit/Geocoder",  
			   "esri/symbols/SimpleFillSymbol",
			   "esri/symbols/SimpleMarkerSymbol",
			   "esri/InfoTemplate",
			   "esri/dijit/InfoWindowLite",
			   "esri/graphic",
			   "dojo/data/ItemFileReadStore",
				"dojox/mobile/DataCarousel",
				"esri/layers/FeatureLayer",
				"dojox/mobile/parser",
				"dojo/_base/lang",
				"esri/toolbars/draw",
				"dojox/mobile",
				"dojox/mobile/deviceTheme",
				"dojo/domReady!"], 
		function(Map, on, Edit, Color, Geocoder, SimpleFillSymbol, SimpleMarkerSymbol, InfoTemplate, infoWindowLite, Graphic, ItemFileReadStore, DataCarousel, FeatureLayer, Parser, lang, Draw) {
        
		var map = new Map("map", {
          basemap: "topo",
          center: [-122.45,37.75], // long, lat
          zoom: 3,
          sliderStyle: "small"
        });
		
		var editToolbar = new Edit(map);
		var infoWindowLite = new esri.dijit.InfoWindowLite(null, dojo.create("div", null, map.root));
        infoWindowLite.startup();
        
		
		map.on("load", mapLoaded);

		var featureLayer;
		
		function mapLoaded() {
		  map.setInfoWindow(infoWindowLite);
		  var infoTemplate = new InfoTemplate("${destination}");
		  featureLayer = FeatureLayer("http://services1.arcgis.com/epWj2EmjrgksS4ol/arcgis/rest/services/gameIt_Sports_Fields/FeatureServer/0", {
			mode: FeatureLayer.MODE_ONDEMAND,
            outFields: ["destination"],
            infoTemplate: infoTemplate
          });
		  map.addLayer(featureLayer);
		  
		  map.graphics.on("dbl-click", function(evt) {
            //event.stop(evt);
            activateToolbar(evt.graphic);
          });
		}

		var geocoder = new Geocoder({ 
          map: map,
		  autoComplete: true,
		  isDoubleClickZoom: false,
		  maxLocations: 1
        }, "search");

		geocoder.on("select", function(data){
			if (data.result)
			{
				var geometry = data.result.feature.geometry;
				var destination = data.result.name;
			}
		});
		
		function addToMap(evt) {
          var symbol;
          toolbar.deactivate();
          map.showZoomSlider();
          symbol = new SimpleFillSymbol();
          var graphic = new Graphic(evt.geometry, symbol);
          map.graphics.add(graphic);
		  
		  //add to geometry
		  var sms = new SimpleMarkerSymbol().setStyle(SimpleMarkerSymbol.STYLE_CIRCLE).setColor(new Color([255,0,0,0.5]));
		  var date = new Date().getTime();
		  var attr = {"start": date, "end": date, "sport":"soccer","type":0, "location":"tets"};
		  var infoTemplate = new InfoTemplate("destination");
	      var graphic = new Graphic(evt.geometry,sms,attr,infoTemplate);
		  featureLayer.applyEdits([graphic],null,null,function(r){console.log(r)},function(r){console.log(e)});
        }

		geocoder.startup();		
		var toolbar = new Draw(map);
		toolbar.activate(Draw["POLYGON"]);
		toolbar.on("draw-end", addToMap);
	
		function activateToolbar(graphic) {
          var tool = 0;      
          //if (registry.byId("tool_move").checked) {
            tool = tool | Edit.MOVE; 
          //}
          //if (registry.byId("tool_vertices").checked) {
            tool = tool | Edit.EDIT_VERTICES; 
          //}
          //if (registry.byId("tool_scale").checked) {
            tool = tool | Edit.SCALE; 
          //}
          //if (registry.byId("tool_rotate").checked) {
            tool = tool | Edit.ROTATE; 
          //}
          //specify toolbar options        
          var options = {
            allowAddVertices: true,
            allowDeleteVertices: true,
            uniformScaling: false
          };
          editToolbar.activate(tool, graphic, options);
        }
      });
    </script>
	<script>
		$(document).foundation();
	</script>
</body>
</html>
